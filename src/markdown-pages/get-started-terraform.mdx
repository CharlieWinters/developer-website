---
path: '/guides/get-started-terraform'
duration: '20 min'
title: 'Set up New Relic using Terraform'
template: 'GuideTemplate'
description: "Learn how to provision New Relic resources using [Terraform](https://www.terraform.io/)."
---

In this guide you'll learn how to set up New Relic for the first time with [Terraform](https://www.terraform.io/). Specifically, you are going to provision an alert policy with notifications in your New Relic account using Terraform.

<Video id="vifxeilp2h" type="wistia"/>

## Before you begin

To use this guide, you should have some basic knowledge of both New Relic and Terraform.

* If you haven't deployed a New Relic agent yet, [install New Relic](https://docs.newrelic.com/docs/agents/manage-apm-agents/installation/install-agent) for your application. 
* [Install Terraform CLI](https://www.terraform.io/intro/getting-started/install.html).
* Locate your [New Relic Admin API key](https://docs.newrelic.com/docs/apis/get-started/intro-apis/types-new-relic-api-keys#admin).
* Set your Admin API key with the `NEWRELIC_API_KEY` environment variable. 

New Relic's Terraform Provider detects the `NEWRELIC_API_KEY` environment variable when running Terraform commands. You can set `NEWRELIC_API_KEY` environment variable in your `.bash_profile` or `.bashrc` file:

```bash
# Add this to your .bash_profile
export NEWRELIC_API_KEY=abc123
```

Or set it inline when running `terraform plan` or `terraform apply`:

```bash
$ NEWRELIC_API_KEY=abc123 terraform apply
```

## Start with a provider configuration

To connect Terraform with New Relic, you need to set New Relic as a provider in your Terraform configuration file. This is necessary so that Terraform can create and manage New Relic resources in your account.

To set New Relic as a provider, create a Terraform configuration file (`main.tf`) with the following code:

```hcl
provider "newrelic" {}

resource "newrelic_alert_policy" "alert_policy_name" {
  name = "My Alert Policy Name"
}
```

This code sets `newrelic` as the Terraform provider and provisions an empty [alert policy](/docs/alerts/new-relic-alerts/configuring-alert-policies/create-edit-or-find-alert-policy) as the resource.

## Initialize and test your setup

After adding New Relic as a provider, [initialize](https://www.terraform.io/docs/commands/init.html) the working directory from the command line:

```bash
$ terraform init
```

Once you've successfully initialized the working directory, test Terraform's [execution plan](https://www.terraform.io/docs/commands/plan.html) to confirm that you've the right setup:

```bash
$ terraform plan
```

`plan` performs a [dry run](https://en.wikipedia.org/wiki/Dry_run_(testing)) of your Terraform configuration, so nothing is actually provisioned. Always run `plan` to test your configuration before applying it.

## Add an alert condition to the alert policy

The alert policy you defined in `main.tf` does not contain any alert condition. You are going to add an alert condition linked to your application.

First, to store your application's information, you need to add a [data source](https://www.terraform.io/docs/configuration-0-11/data-sources.html):

```hcl
provider "newrelic" {}

# Data Source
data "newrelic_application" "app_name" {
  name = "my-app" # This must be an exact match of your app name in New Relic (case sensitive)
}

resource "newrelic_alert_policy" "alert_policy_name" {
  name = "My Alert Policy Name"
}
```

Now you can add the alert condition. For example, you can create a `critical` alert condition that is triggered when the [Apdex score](https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/apdex-measure-user-satisfaction) of your application falls below `0.75` for five minutes:

```hcl
provider "newrelic" {}

data "newrelic_application" "app_name" {
  name = "my-app"
}

resource "newrelic_alert_policy" "alert_policy_name" {
  name = "My Alert Policy Name"
}

# Alert condition
resource "newrelic_alert_condition" "alert_condition_name" {
  policy_id = newrelic_alert_policy.alert_policy_name.id

  name            = "My Alert Condition Name"
  type            = "apm_app_metric"
  entities        = [data.newrelic_application.app_name.id]
  metric          = "apdex"
  runbook_url     = "https://www.example.com"
  condition_scope = "application"

  term {
    duration      = 5
    operator      = "below"
    priority      = "critical"
    threshold     = "0.75"
    time_function = "all"
  }
}
```

## Add a notification channel

Alert policies use [notification channels](https://docs.newrelic.com/docs/alerts/new-relic-alerts/managing-notification-channels/notification-channels-control-where-send-alerts) to inform you about incidents and active alerts. 

To add a notification channel to your alert policy, add the following snippet to your configuration file:

```hcl
# Notification channel
resource "newrelic_alert_channel" "alert_notification_email" {
  name = "paul@example.com"
  type = "email"

  config {
    recipients              = "fab@example.com"
    include_json_attachment = "1"
  }
}

# Link the above notification channel to your policy
resource "newrelic_alert_policy_channel" "alert_policy_email" {
  policy_id  = newrelic_alert_policy.alert_policy_name.id
  channel_ids = [
    newrelic_alert_channel.alert_notification_email.id
  ]
}
```

When the alert condition is triggered, the notification channel sends an email to the specified `recipients`. You can send notifications using different tools and channels, such as Slack, by changing the `type` of your [alert channel](https://www.terraform.io/docs/providers/newrelic/r/alert_channel.html).

## Apply your Terraform configuration

The last step is provisioning the resources you've configured in `main.tf`, so that the alert policy is enabled in your New Relic account for your application.

To [apply](https://www.terraform.io/docs/commands/apply.html) the Terraform configuration and provision the resources in your New Relic account, run the `apply` command:

```bash
$ terraform apply
```

Answer `yes` when prompted to apply the changes. Once the `apply` process is complete, you should see the new alert policy you've provisioned using Terraform, and its alert conditions, in your New Relic account.

You can run `terraform apply` every time you need to make changes to your configuration. To eliminate the resources you've provisioned, run [`terraform destroy`](https://www.terraform.io/docs/commands/destroy.html).

## Tip: Use the `apm` module for faster configuration

In the Terraform Registry you can find [our `apm` module](https://registry.terraform.io/modules/newrelic/apm/newrelic/0.0.4), which simplifies Terraform's configuration. `apm` creates an alert policy, a [Synthetics monitor](https://docs.newrelic.com/docs/synthetics/new-relic-synthetics/using-monitors/add-edit-monitors), and several alert conditions for a given application reporting data into New Relic.

To use our `apm` module with Terraform:

1. Set `newrelic/apm/newrelic` as the module source.
2. Add your `account_id` and `application_name`.
3. Define your `application_url` (if any).

Here is a configuration example with overridden default values:

```hcl
data "newrelic_alert_channel" "pager" {
    name = "Page Developer Toolkit Team"
}

module "dummy-app-monitor" {
    source = "newrelic/apm/newrelic"

    account_id = 2520528
    application_name = "Dummy App"

    # An Apdex alert condition will be created with sensible defaults without the use of these attributes.
    apdex_warning_threshold = 0.9
    apdex_critical_threshold = 0.8

    # An error rate alert condition will be created with sensible defaults without the use of these attributes.
    error_rate_warning_threshold = 5
    error_rate_critical_threshold = 10

    # Specifying an application URL will provision a Synthetics monitor and associated alert condition.
    application_url = "https://www.dummyapp.com"
    synthetics_monitor_verify_ssl = true

    # Response time alert condition will not be provisioned unless a critical violation threshold is specified.
    response_time_critical_threshold = 3

    channel_ids = [data.newrelic_alert_channel.pager.id]
}
```

Initialize the working directory to download and enable the module:

```bash
$ terraform init
```

> The `apm` module doesn't create a notification channel, so you would still have to define one.

## Tip: Avoid resources being marked as "sensitive"

When API results are deemed to be secret and are obfuscated, Terraform may be unable to detect the state of a resource, marking it as changed. Consider this example:

```hcl
resource "newrelic_alert_channel" "slack" {
  name = "slack"
  type = "slack"

  config {
    channel = "test"
    url     = "https://hooks.slack.com/services/xxxx/xxxxx"
  }
}
```

Running `terraform plan` yields the following:

```
    -/+ newrelic_alert_channel.slack (new resource required)
          id:                    "2344397" => <computed> (forces new resource)
          config.%:              "1" => "2" (forces new resource)
          config.channel:        <sensitive> => <sensitive> (attribute changed)
          config.url:            <sensitive> => <sensitive> (forces new resource)
          name:                  "slack" => "slack"
          type:                  "slack" => "slack"
```

To prevent Terraform from wrongly marking a resource as changed, add an [`ignore_changes`](https://www.terraform.io/docs/configuration/resources.html#ignore_changes) directive:

```hcl
resource "newrelic_alert_channel" "slack" {
  ...
  lifecycle {
    ignore_changes = ["config"]
  }
}
  ...
```

This avoids changes to resources caused by obfuscated items.

## Related info

- [Terraform New Relic Provider](https://www.terraform.io/docs/providers/newrelic/index.html)
- [New Relic documentation](https://docs.newrelic.com)
- [Terraform documentation](https://www.terraform.io/docs/index.html)